# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "ehci_pci" "ata_piix" "usb_storage" "usbhid" "sd_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "vfio-pci" "nvidia_uvm" ];
  boot.kernelParams = [ # "quiet" "vga=current" "udev.log_level=3" "rd.systemd.show_status=auto" "nowatchdog"
    # "amdgpu.ppfeaturemask=0xffffffff"
"video=efifb:off" 
"video=vesafb:off"
"nvidia.NVreg_EnableGpuFirmware=0"
"nvidia-drm.modeset=0"  # Disable display mode setting
"nvidia-drm.fbdev=0"    # Disable the NVIDIA-controlled console buffer
    "usbhid.mousepoll=1"   "raid0.default_layout=2" ];
  # boot.loader.timeout = 1;
  services.fstrim.enable = lib.mkDefault true;
  # hardware.hidpi.enable = true;

  fileSystems."/" =
    { device = "/dev/nvme0n1p2";
      # options = [ "noatime" ];
      fsType = "ext4";
    };

  fileSystems."/boot/efi" =
    { device = "/dev/nvme0n1p1";
      fsType = "vfat";
      options = [ "defaults" ];
    };

  fileSystems."/mnt/old" =
    { device = "/dev/disk/by-id/ata-BRAVEEAGLE_SSD_240GB_AA00000000540-part1";
      options = [ "noatime" ];
      fsType = "ext4";
    };

  fileSystems."/mnt/new" =
    { device = "/dev/disk/by-id/ata-XrayDisk_1TB_SSD_AA000000000000000117-part1";
      options = [ "noatime" "discard" "nodelalloc" "commit=60" ];
      fsType = "ext4";
    };

  hardware.display.edid.enable = true;
  hardware.display.outputs.HDMI-A-2.edid = "1800x1080.bin";
  hardware.display.edid.packages = [
    (pkgs.edid-generator.overrideAttrs {
      clean = true;
      modelines = ''
      Modeline "1440x864_60"  102.25  1440 1520 1672 1904  864 867 874 897 -hsync +vsync ratio=16:10
      Modeline "864_59.75"  101.75  1440 1520 1672 1904  864 867 874 897 -hsync +vsync ratio=16:10
      Modeline "1800x1080"  161.75  1800 1912 2104 2408  1080 1083 1090 1120 -hsync +vsync ratio=16:10
      Modeline "1800_30.00"   74.75  1800 1856 2032 2264  1080 1083 1090 1102 -hsync +vsync ratio=16:10
      Modeline "2000_60"  200.50  2000 2136 2344 2688  1200 1203 1213 1245 -hsync +vsync ratio=16:10

      Modeline "1800x1080R"  130.50  1800 1848 1880 1960  1080 1083 1090 1111 +hsync -vsync ratio=16:10

    '';
    })
  ];

  # TODO fix permissions
  # https://superuser.com/questions/174776/modify-fstab-entry-so-all-users-can-read-and-write-to-an-ext4-volume
  fileSystems."/mnt/md127" =
    { device = "/dev/md127";
      options = [ "noatime" ];
      fsType = "ext4";
    };

  swapDevices = [
    # {
    #   device = "/dev/disk/by-uuid/6461bae0-3f65-4d32-9a2f-696b57250ab2";
    #   # size = 96*1024;
    # }
    {
      device = "/swapfile2";
      size = 32 * 1024;
    }
  ];

  # Enables DHCP on each ethernet and wireless interface. In case of scripted networking
  # (the default) this is the recommended approach. When using systemd-networkd it's
  # still possible to use this option, but it's recommended to use it in conjunction
  # with explicit per-interface declarations with `networking.interfaces.<interface>.useDHCP`.
  networking.useDHCP = true;
  # networking.interfaces.enp3s0.useDHCP = true;
  networking.enableIPv6 = true;

  # hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}
