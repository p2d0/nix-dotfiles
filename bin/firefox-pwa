#!/usr/bin/env bash
URL="$1"

if [[ -z "$URL" ]]; then
    echo "Usage: firefox-pwa <url>"
    exit 1
fi

# Get current Firefox window addresses
before=$(hyprctl clients -j | jq -r '[.[] | select(.class == "firefox") | .address] | sort | join("\n")')

# Launch Firefox
setsid firefox --new-window "$URL" &

# Wait for new window to appear (max 10 seconds)
for i in {1..100}; do
    after=$(hyprctl clients -j | jq -r '[.[] | select(.class == "firefox") | .address] | sort | join("\n")')
    
    # Find the new address that wasn't in before
    new_addr=$(comm -13 <(echo "$before") <(echo "$after") | head -1)
    
    if [[ -n "$new_addr" ]]; then
        # Small delay to let window settle
        sleep 0.3
        hyprctl dispatch focuswindow "address:$new_addr"
        hyprctl dispatch fullscreenstate 0 2
        exit 0
    fi
    sleep 0.1
done

echo "Timeout waiting for Firefox window"
exit 1o
